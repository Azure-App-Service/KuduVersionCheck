@using System.Diagnostics;
@using System.Reflection;

@functions {
    Dictionary<string, string> props = new Dictionary<string, string>();
    string siteExtFolder = @"D:\Program Files (x86)\SiteExtensions";
    string nodeFolder = @"D:\Program Files (x86)\nodejs";
    string npmFolder = @"D:\Program Files (x86)\npm";
    string goFolder = @"D:\Program Files\Go";

    class FancyVersion : IComparable<FancyVersion>
    {
        public FancyVersion(string ver)
        {
            VersionString = ver;
        }

        public string VersionString { get; set; }

        public int CompareTo(FancyVersion other)
        {
            try
            {
                return Semver.SemVersion.Parse(VersionString).CompareTo(Semver.SemVersion.Parse(other.VersionString));
            }
            catch
            {
            }

            try
            {
                // Fall back to .net version for cases when there are 4 chunks
                return (new Version(VersionString)).CompareTo(new Version(other.VersionString));
            }
            catch
            {
                return 0;
            }
        }
    }

    void AddSiteExtension(string folderName, string name = null, string ignoreVerAndAbove = "999999999.0")
    {
        name = name ?? folderName;
        
        string extensionFolder = Path.Combine(siteExtFolder, folderName);
        if (Directory.Exists(extensionFolder))
        {
            props[name] = GetLatestVersionFromFolder(extensionFolder, ignoreVerAndAbove);
        }
        else
        {
            props[name] = "none";
        }
    }

    string GetLatestVersionFromFolder(string folder, string ignoreVerAndAbove = "999999999.0")
    {
        var maxVer = new FancyVersion(ignoreVerAndAbove);
        try
        {
            var folders = from childFolder in Directory.GetDirectories(folder)
                          let fancyVer = new FancyVersion(Path.GetFileName(childFolder))
                          where fancyVer.CompareTo(maxVer) < 0
                          orderby fancyVer descending
                          select childFolder;
                             
            string highestVersionFolder = folders.First();
            return Path.GetFileName(highestVersionFolder);
        }
        catch
        {
            return "error";
        }
    }

    private long GetTotalFreeSpace(string driveName)
    {
        foreach (DriveInfo drive in DriveInfo.GetDrives())
        {
            if (drive.IsReady && drive.Name == driveName)
            {
                return drive.TotalFreeSpace;
            }
        }
        return -1;
    }

    private static string FormatBytes(long bytes)
    {
        string[] Suffix = { "B", "KB", "MB", "GB", "TB" };
        int i;
        double dblSByte = bytes;
        for (i = 0; i < Suffix.Length && bytes >= 1024; i++, bytes /= 1024) 
        {
            dblSByte = bytes / 1024.0;
        }
    
        return String.Format("{0:0.##} {1}", dblSByte, Suffix[i]);
    }


    private static double GetWritePerf()
    {
        string testFilePath = Environment.ExpandEnvironmentVariables(@"%HOME%\site\FileSystemPerf.txt");
        
        var start = DateTime.Now;
        double total = 0;
        int maxIteration = 10;
        for (int i = 0; i < maxIteration; i++)
        {
            var iterationStart = DateTime.Now;
            File.WriteAllText(testFilePath, "Hello");

            double ms = (DateTime.Now - iterationStart).TotalMilliseconds;
            total += ms;
        }

        return (DateTime.Now - start).TotalMilliseconds / maxIteration;
    }
}

@{
    var assembly = System.Reflection.Assembly.Load("Microsoft.Web.Hosting, Version=7.1.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35");
    var fileVersionInfo = System.Diagnostics.FileVersionInfo.GetVersionInfo(assembly.Location);
    props["waws"] = fileVersionInfo.ProductVersion;

    string version = (string)Microsoft.Win32.Registry.GetValue(
        @"HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion", 
        "BuildLab", null);
    props["osversion"] = version.Split('.')[2];

/*
    // Use Node to get the cpu, since standard C# code doesn't run in sandbox
    string nodeFile = Path.Combine(HttpRuntime.AppDomainAppPath, "cpu.js");
    File.WriteAllText(nodeFile,"var os = require('os'); console.log(os.cpus()[0].model);");
    var proc = new Process {
        StartInfo = new ProcessStartInfo {
            FileName = @"D:\Program Files (x86)\nodejs\8.4.0\node.exe",
            Arguments = Path.Combine(HttpRuntime.AppDomainAppPath, "cpu.js"),
            UseShellExecute = false,
            RedirectStandardOutput = true,
            CreateNoWindow = true,
            WorkingDirectory = HttpRuntime.AppDomainAppPath
        }
    };
    proc.Start();
    props["cpu"] = proc.StandardOutput.ReadLine();
*/

    AddSiteExtension("Kudu");
    AddSiteExtension("Monaco");
    AddSiteExtension("MobileServicesDotNet", "ZuNet");
    AddSiteExtension("MobileServicesNode", "ZuNode");
    AddSiteExtension("MobileAppsManagement", "ZuManage");
    AddSiteExtension("AzureJobs");
    AddSiteExtension("MSDeploy");
    //props["msd"] = File.Exists(@"D:\Program Files (x86)\SiteExtensions\MSDeploy\3.5.51024.2802\bin\Microsoft.Web.Deployment.dll").ToString();
    AddSiteExtension("DaaS");
    AddSiteExtension("LogAnalyzer");
    //AddSiteExtension("SecurityInsightAdmin", "SecInsight");
    //props["func2"] = GetLatestVersionFromFolder(@"D:\Program Files (x86)\SiteExtensions\Functions", "0.3");
    //props["func3"] = GetLatestVersionFromFolder(@"D:\Program Files (x86)\SiteExtensions\Functions", "0.4");
    AddSiteExtension("Functions", ignoreVerAndAbove: "1.0.99999");
    AddSiteExtension("Functions", "func20");
    //AddSiteExtension("Functions", "funcbeta");
    AddSiteExtension("routing");
    //AddSiteExtension("ApiAppsGateway", "Gateway");
    //AddSiteExtension("Zray54");
    AddSiteExtension("appidentify");
    AddSiteExtension("PerformanceTesting", "perf");
    AddSiteExtension("AzureBotService", "bot", ignoreVerAndAbove: "2.0");


    //props["pubdll"] = File.Exists(@"D:\Program Files (x86)\MSBuild\Microsoft\VisualStudio\v14.0\Web\Microsoft.Web.Publishing.Tasks.dll").ToString();
    //props["analysis"] = File.Exists(@"D:\Program Files (x86)\MSBuild\Microsoft\VisualStudio\v14.0\CodeAnalysis\fxcoptask.dll").ToString();
    props["core10"] = GetLatestVersionFromFolder(@"D:\Program Files (x86)\dotnet\shared\Microsoft.NETCore.App", "1.0.9");
    props["core11"] = GetLatestVersionFromFolder(@"D:\Program Files (x86)\dotnet\shared\Microsoft.NETCore.App", "1.1.99");
    props["core20"] = GetLatestVersionFromFolder(@"D:\Program Files (x86)\dotnet\shared\Microsoft.NETCore.App");
    props["sdk"] = GetLatestVersionFromFolder(@"D:\Program Files (x86)\dotnet\sdk");

    fileVersionInfo = System.Diagnostics.FileVersionInfo.GetVersionInfo(@"D:\Program Files (x86)\iisnode\iisnode.dll");
    props["iisnode"] = fileVersionInfo.FileVersion;
    
    fileVersionInfo = System.Diagnostics.FileVersionInfo.GetVersionInfo(@"D:\Windows\SysWOW64\inetsrv\aspnetcore.dll");
    props["ancm"] = fileVersionInfo.FileVersion;
    
    props["mds"] = GetLatestVersionFromFolder(@"D:\Program Files\Mds");

    props["Node4"] = GetLatestVersionFromFolder(nodeFolder, "5");
    props["Node6"] = GetLatestVersionFromFolder(nodeFolder, "7");
    props["Node7"] = GetLatestVersionFromFolder(nodeFolder, "8");
    props["Node8"] = GetLatestVersionFromFolder(nodeFolder);
    props["npm1"] = GetLatestVersionFromFolder(npmFolder, "2");
    props["npm"] = GetLatestVersionFromFolder(npmFolder);
    //props["go"] = GetLatestVersionFromFolder(goFolder);
    //props["jdbc"] = File.Exists(@"D:\Program Files (x86)\apache-tomcat-8.0.23\lib\sqljdbc.jar").ToString();
    //props["MA"] = File.Exists(@"D:\Program Files\Mds\34.2.3.0\agent\MonAgentLauncher.exe").ToString();

    //props["dotnet"] = Environment.GetEnvironmentVariable("PATH").Contains("dotnet").ToString();

    string appHostPath = Environment.ExpandEnvironmentVariables(@"%tmp%\..\config\applicationhost.config");
    string appHostContent = File.ReadAllText(appHostPath);
    
    //props["Fx452Refs"] = File.Exists(@"D:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\.NETFramework\v4.5.2\Accessibility.dll").ToString();
    
    Assembly a=null;
    try
    {
        a = Assembly.Load("Newtonsoft.Json, Version=6.0.0.0, Culture=neutral, PublicKeyToken=30ad4fe6b2a6aeed");
    }
    catch
    {
    }
    //props["jsongate"] = (a != null).ToString();

    try
    {
        //props["en-SE"] = System.Globalization.CultureInfo.GetCultureInfo("en-SE").DisplayName;
    }
    catch
    {
        props["en-SE"] = "No";
    }

    props["FreeDSpace$"] = FormatBytes(GetTotalFreeSpace(@"D:\"));

    try
    {
        props["WritePerf$"] = GetWritePerf().ToString("0.00");
    }
    catch
    {
        props["WritePerf$"] = "error";
    }

    //props["4.5.1 SDK"] = (File.Exists(@"D:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\.NETFramework\v4.5.1\Accessibility.dll") &&
    //                     File.Exists(@"D:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\.NETFramework\v4.5.1\Accessibility.xml")).ToString();

    //props["4.5.2 SDK"] = File.Exists(@"D:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\.NETFramework\v4.5.2\facades\System.Collections.dll").ToString();

    //props["UNENCODED_URL$"] = Request.ServerVariables["UNENCODED_URL"];
    
    //props["ScmSep"] = appHostContent.Contains(@"add name=""~1").ToString();
    
    //props["PHP55"] = (appHostContent.Contains(@"PHP55_via_FastCGI") && appHostContent.Contains(@"D:\Program Files (x86)\PHP\v5.5\php-cgi.exe")).ToString();

    //var info = new FileInfo(@"D:\Program Files\iisnode\interceptor.js");
    //props["interceptor"] = info.Length.ToString();

    // Time is not that useful, so yanking it
    //props["time"] = File.GetCreationTimeUtc(mwhAssembly.Location).ToString();

    Response.ContentType = "application/json";
}

@Html.Raw(Json.Encode(props))
